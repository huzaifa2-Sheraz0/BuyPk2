CREATE DATABASE IF NOT EXISTS buy_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE buy_db;

CREATE TABLE IF NOT EXISTS users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(120) NOT NULL,
  email VARCHAR(190) NOT NULL UNIQUE,
  password_hash VARCHAR(255) NOT NULL,
  phone VARCHAR(40) DEFAULT NULL,
  address VARCHAR(255) DEFAULT NULL,
  role ENUM('customer','admin','company') NOT NULL DEFAULT 'customer',
  avatar VARCHAR(255) DEFAULT NULL,
  joined_date DATE NOT NULL,
  status ENUM('active','disabled') NOT NULL DEFAULT 'active',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS products (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(190) NOT NULL,
  price DECIMAL(10,2) NOT NULL DEFAULT 0,
  old_price DECIMAL(10,2) DEFAULT NULL,
  category VARCHAR(80) NOT NULL DEFAULT 'uncategorized',
  image VARCHAR(255) DEFAULT NULL,
  image2 VARCHAR(255) DEFAULT NULL,
  image3 VARCHAR(255) DEFAULT NULL,
  rating DECIMAL(3,2) NOT NULL DEFAULT 0,
  reviews INT NOT NULL DEFAULT 0,
  badge VARCHAR(20) DEFAULT NULL,
  description TEXT DEFAULT NULL,
  colors TEXT DEFAULT NULL,
  stock INT NOT NULL DEFAULT 0,
  created_at DATE NOT NULL,
  brand VARCHAR(120) DEFAULT NULL,
  specs TEXT DEFAULT NULL,
  created_ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_category (category),
  INDEX idx_badge (badge),
  INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS orders (
  id INT AUTO_INCREMENT PRIMARY KEY,
  order_code VARCHAR(40) NOT NULL UNIQUE,
  tracking_number VARCHAR(40) NOT NULL UNIQUE,
  user_id INT DEFAULT NULL,
  user_name VARCHAR(120) NOT NULL,
  user_email VARCHAR(190) NOT NULL,
  user_phone VARCHAR(40) DEFAULT NULL,
  user_address VARCHAR(255) NOT NULL,
  user_city VARCHAR(80) NOT NULL,
  user_country VARCHAR(80) NOT NULL,
  shipping_method VARCHAR(40) DEFAULT 'standard',
  payment_method VARCHAR(40) DEFAULT 'cod',
  status ENUM('processing','shipped','delivered','cancelled') NOT NULL DEFAULT 'processing',
  subtotal DECIMAL(10,2) NOT NULL DEFAULT 0,
  shipping DECIMAL(10,2) NOT NULL DEFAULT 0,
  tax DECIMAL(10,2) NOT NULL DEFAULT 0,
  total DECIMAL(10,2) NOT NULL DEFAULT 0,
  estimated_delivery DATE DEFAULT NULL,
  ordered_at DATETIME NOT NULL,
  delivered_at DATETIME DEFAULT NULL,
  created_ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_user_email (user_email),
  INDEX idx_user_id (user_id),
  INDEX idx_status (status),
  CONSTRAINT fk_orders_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS order_items (
  id INT AUTO_INCREMENT PRIMARY KEY,
  order_id INT NOT NULL,
  product_id INT DEFAULT NULL,
  name VARCHAR(190) NOT NULL,
  quantity INT NOT NULL DEFAULT 1,
  price DECIMAL(10,2) NOT NULL DEFAULT 0,
  created_ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_order_id (order_id),
  CONSTRAINT fk_order_items_order FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS contacts (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(120) NOT NULL,
  email VARCHAR(190) NOT NULL,
  subject VARCHAR(190) NOT NULL,
  message TEXT NOT NULL,
  status VARCHAR(40) NOT NULL DEFAULT 'received',
  ticket_number VARCHAR(40) NOT NULL,
  created_at DATETIME NOT NULL,
  INDEX idx_email (email),
  INDEX idx_ticket (ticket_number)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
